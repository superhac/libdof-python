name: Build

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:

          # ----------------------------------------------------------------
          # Linux x64
          # ----------------------------------------------------------------
          - name: Linux x64
            os: ubuntu-latest
            platform: linux
            arch: x64
            dof_lib_glob: 'libdof/build/libdof.so*'
            wrapper_lib: libdof_python.so

          # ----------------------------------------------------------------
          # macOS arm64  (Apple Silicon)
          # ----------------------------------------------------------------
          - name: macOS arm64
            os: macos-latest
            platform: macos
            arch: arm64
            dof_lib_glob: 'libdof/build/libdof*.dylib'
            wrapper_lib: libdof_python.dylib

          # ----------------------------------------------------------------
          # Windows x64
          # ----------------------------------------------------------------
          - name: Windows x64
            os: windows-latest
            platform: win
            arch: x64
            dof_lib_glob: 'libdof/build/Release/dof64.dll'
            wrapper_lib: libdof_python.dll

    steps:
      # --------------------------------------------------------------------
      # Checkout this repo (Python wrapper)
      # --------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------
      # Checkout libdof alongside it
      # --------------------------------------------------------------------
      - name: Checkout libdof
        uses: actions/checkout@v4
        with:
          repository: jsm174/libdof
          path: libdof

      # --------------------------------------------------------------------
      # Install system build tools needed by libdof's external.sh scripts
      # --------------------------------------------------------------------
      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool \
            cmake build-essential \
            libusb-1.0-0-dev

      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: brew install autoconf automake libtool cmake

      # --------------------------------------------------------------------
      # External dependencies — libdof bundles a script per platform/arch
      # that downloads and builds hidapi, libusb, libftdi, libserialport
      # --------------------------------------------------------------------
      - name: Fetch external dependencies (Linux / macOS)
        if: runner.os != 'Windows'
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      - name: Fetch external dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build libdof
      # --------------------------------------------------------------------
      - name: Configure libdof
        run: >
          cmake
          -DPLATFORM=${{ matrix.platform }}
          -DARCH=${{ matrix.arch }}
          -DCMAKE_BUILD_TYPE=Release
          -B build
        working-directory: libdof

      - name: Build libdof
        run: cmake --build build --config Release
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build the Python C wrapper — libdof_python.so / .dylib / .dll
      # --------------------------------------------------------------------
      - name: Build Python wrapper (Linux)
        if: matrix.platform == 'linux'
        run: |
          g++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -Wl,-rpath,'$ORIGIN'

      - name: Build Python wrapper (macOS)
        if: matrix.platform == 'macos'
        run: |
          clang++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -install_name @rpath/${{ matrix.wrapper_lib }} \
            -Wl,-rpath,@loader_path

      - name: Setup MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Python wrapper (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          cl.exe /LD /std:c++17 /EHsc /O2 ^
            /Fe:${{ matrix.wrapper_lib }} ^
            dof_c_api.cpp ^
            /I libdof\include ^
            /I libdof\third-party\include ^
            libdof\build\Release\dof64.lib

      # --------------------------------------------------------------------
      # Collect everything into a dist/ folder for upload
      # --------------------------------------------------------------------
      - name: Collect artifacts (Linux / macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/* dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Collect artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/*.dll dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dof-python-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/

  # --------------------------------------------------------------------------
  # On a version tag (v*), zip the artifacts and attach them to a GH release
  # --------------------------------------------------------------------------
  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip each platform bundle
        run: |
          cd artifacts
          for dir in */; do
            zip -r "../${dir%/}.zip" "$dir"
          done
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: '*.zip'
          generate_release_notes: true
