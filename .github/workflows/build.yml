name: Build

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:

          # ----------------------------------------------------------------
          # Linux x64
          # ----------------------------------------------------------------
          - name: Linux x64
            os: ubuntu-latest
            platform: linux
            arch: x64
            dof_lib_glob: 'libdof/build/libdof.so*'
            wrapper_lib: libdof_python.so

          # ----------------------------------------------------------------
          # macOS arm64
          # ----------------------------------------------------------------
          - name: macOS arm64
            os: macos-latest
            platform: macos
            arch: arm64
            dof_lib_glob: 'libdof/build/libdof*.dylib'
            wrapper_lib: libdof_python.dylib

          # ----------------------------------------------------------------
          # Windows x64
          # ----------------------------------------------------------------
          - name: Windows x64
            os: windows-latest
            platform: win
            arch: x64
            dof_lib_glob: 'libdof/build/Release/dof64.dll'
            wrapper_lib: libdof_python.dll

    steps:

      # --------------------------------------------------------------------
      # Checkout wrapper repo
      # --------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------
      # Checkout libdof
      # --------------------------------------------------------------------
      - name: Checkout libdof
        uses: actions/checkout@v4
        with:
          repository: jsm174/libdof
          path: libdof

      # --------------------------------------------------------------------
      # Linux deps
      # --------------------------------------------------------------------
      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool \
            cmake build-essential \
            libusb-1.0-0-dev \
            libudev-dev

      # --------------------------------------------------------------------
      # macOS deps
      # --------------------------------------------------------------------
      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: brew install autoconf automake libtool cmake

      # --------------------------------------------------------------------
      # Setup MSVC
      # --------------------------------------------------------------------
      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # --------------------------------------------------------------------
      # Setup MSYS2 (Windows)
      # cmake is installed so the MSYS2 subprocess that external.sh spawns
      # for libftdi has cmake available at /usr/bin/cmake.
      # --------------------------------------------------------------------
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: true
          path-type: inherit
          install: >-
            cmake
            make

      # Prepend the Windows cmake AFTER setup-msys2 finishes adding MSYS2
      # paths, so the Windows cmake wins in the bash context (hidapi needs
      # "Visual Studio 17 2022").  MSYS2 subprocesses prepend /usr/bin
      # themselves, so they still see their own cmake first (needed by libftdi).
      - name: Prepend Windows CMake to PATH (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "C:/Program Files/CMake/bin" >> "$GITHUB_PATH"

      # --------------------------------------------------------------------
      # Fetch external deps
      # --------------------------------------------------------------------
      - name: Fetch external dependencies (Linux / macOS)
        if: runner.os != 'Windows'
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      - name: Fetch external dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        env:
          MSYS2_PATH_TYPE: inherit
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      # --------------------------------------------------------------------
      # Configure libdof
      # --------------------------------------------------------------------
      # Use the full path to the Windows cmake so msys2/setup-msys2 adding
      # MSYS2's cmake.exe to the front of PATH doesn't shadow it.
      - name: Configure libdof (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          "C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 17 2022" -A x64 ^
            -DPLATFORM=${{ matrix.platform }} ^
            -DARCH=${{ matrix.arch }} ^
            -DCMAKE_BUILD_TYPE=Release ^
            -B build
        working-directory: libdof

      - name: Configure libdof (Linux / macOS)
        if: runner.os != 'Windows'
        run: >
          cmake
          -DPLATFORM=${{ matrix.platform }}
          -DARCH=${{ matrix.arch }}
          -DCMAKE_BUILD_TYPE=Release
          -B build
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build libdof
      # --------------------------------------------------------------------
      - name: Build libdof (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: '"C:\Program Files\CMake\bin\cmake.exe" --build build --config Release'
        working-directory: libdof

      - name: Build libdof (Linux / macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --config Release
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build Python wrapper
      # --------------------------------------------------------------------
      - name: Build Python wrapper (Linux)
        if: matrix.platform == 'linux'
        run: |
          g++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -Wl,-rpath,'$ORIGIN'

      - name: Build Python wrapper (macOS)
        if: matrix.platform == 'macos'
        run: |
          clang++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -install_name @rpath/${{ matrix.wrapper_lib }} \
            -Wl,-rpath,@loader_path

      - name: Build Python wrapper (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          cl.exe /LD /std:c++17 /EHsc /O2 ^
            /Fe:${{ matrix.wrapper_lib }} ^
            dof_c_api.cpp ^
            /I libdof\include ^
            /I libdof\third-party\include ^
            libdof\build\Release\dof64.lib

      # --------------------------------------------------------------------
      # Collect artifacts
      # --------------------------------------------------------------------
      - name: Collect artifacts (Linux / macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/* dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Collect artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/*.dll dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dof-python-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/

  # --------------------------------------------------------------------------
  # Release job
  # --------------------------------------------------------------------------
  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip bundles
        run: |
          cd artifacts
          for dir in */; do
            zip -r "../${dir%/}.zip" "$dir"
          done

      - uses: softprops/action-gh-release@v2
        with:
          files: '*.zip'
          generate_release_notes: true
