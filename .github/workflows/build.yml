name: Build

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:

          # ----------------------------------------------------------------
          # Linux x64
          # ----------------------------------------------------------------
          - name: Linux x64
            os: ubuntu-latest
            platform: linux
            arch: x64
            dof_lib_glob: 'libdof/build/libdof.so*'
            wrapper_lib: libdof_python.so

          # ----------------------------------------------------------------
          # macOS arm64
          # ----------------------------------------------------------------
          - name: macOS arm64
            os: macos-latest
            platform: macos
            arch: arm64
            dof_lib_glob: 'libdof/build/libdof*.dylib'
            wrapper_lib: libdof_python.dylib

          # ----------------------------------------------------------------
          # Windows x64
          # ----------------------------------------------------------------
          - name: Windows x64
            os: windows-latest
            platform: win
            arch: x64
            dof_lib_glob: 'libdof/build/Release/dof64.dll'
            wrapper_lib: libdof_python.dll

    steps:

      # --------------------------------------------------------------------
      # Checkout wrapper repo
      # --------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------
      # Checkout libdof
      # --------------------------------------------------------------------
      - name: Checkout libdof
        uses: actions/checkout@v4
        with:
          repository: jsm174/libdof
          path: libdof

      # --------------------------------------------------------------------
      # Linux deps
      # --------------------------------------------------------------------
      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool \
            cmake build-essential \
            libusb-1.0-0-dev \
            libudev-dev

      # --------------------------------------------------------------------
      # macOS deps
      # --------------------------------------------------------------------
      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: brew install autoconf automake libtool cmake

      # --------------------------------------------------------------------
      # Setup MSVC (adds msbuild + cl.exe to PATH)
      # --------------------------------------------------------------------
      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # --------------------------------------------------------------------
      # Install MSYS2 packages needed by external.sh
      # external.sh hard-codes MSYS2_PATH=/c/msys64, so install directly
      # into that installation via pacman.
      # mingw-w64-x86_64-cmake lands in /mingw64/bin (not /usr/bin), so it
      # is invisible to Git Bash (shell: bash) â€” Windows cmake wins for
      # hidapi.  Inside the MSYS2 subprocess external.sh spawns for libftdi,
      # MSYSTEM=MINGW64 puts /mingw64/bin first, so MINGW cmake wins there.
      # --------------------------------------------------------------------
      - name: Install MSYS2 packages (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          /c/msys64/usr/bin/bash.exe -l -c "pacman -S --noconfirm --needed make diffutils"
          /c/msys64/usr/bin/bash.exe -l -c "pacman -S --noconfirm --needed mingw-w64-x86_64-gcc mingw-w64-x86_64-libwinpthread mingw-w64-x86_64-cmake"

      # --------------------------------------------------------------------
      # Fetch external deps
      # --------------------------------------------------------------------
      - name: Fetch external dependencies (Linux / macOS)
        if: runner.os != 'Windows'
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      - name: Fetch external dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: bash platforms/${{ matrix.platform }}/${{ matrix.arch }}/external.sh
        working-directory: libdof

      # --------------------------------------------------------------------
      # Configure libdof
      # --------------------------------------------------------------------
      - name: Configure libdof (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          "C:\Program Files\CMake\bin\cmake.exe" -G "Visual Studio 17 2022" -A x64 ^
            -DPLATFORM=${{ matrix.platform }} ^
            -DARCH=${{ matrix.arch }} ^
            -DCMAKE_BUILD_TYPE=Release ^
            -B build
        working-directory: libdof

      - name: Configure libdof (Linux / macOS)
        if: runner.os != 'Windows'
        run: >
          cmake
          -DPLATFORM=${{ matrix.platform }}
          -DARCH=${{ matrix.arch }}
          -DCMAKE_BUILD_TYPE=Release
          -B build
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build libdof
      # --------------------------------------------------------------------
      - name: Build libdof (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: '"C:\Program Files\CMake\bin\cmake.exe" --build build --config Release'
        working-directory: libdof

      - name: Build libdof (Linux / macOS)
        if: runner.os != 'Windows'
        run: cmake --build build --config Release
        working-directory: libdof

      # --------------------------------------------------------------------
      # Build Python wrapper
      # --------------------------------------------------------------------
      - name: Build Python wrapper (Linux)
        if: matrix.platform == 'linux'
        run: |
          g++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -Wl,-rpath,'$ORIGIN'

      - name: Build Python wrapper (macOS)
        if: matrix.platform == 'macos'
        run: |
          clang++ -shared -fPIC -std=c++17 \
            -o ${{ matrix.wrapper_lib }} \
            dof_c_api.cpp \
            -I libdof/include \
            -I libdof/third-party/include \
            -L libdof/build \
            -ldof \
            -install_name @rpath/${{ matrix.wrapper_lib }} \
            -Wl,-rpath,@loader_path

      - name: Build Python wrapper (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          cl.exe /LD /std:c++17 /EHsc /O2 ^
            /Fe:${{ matrix.wrapper_lib }} ^
            dof_c_api.cpp ^
            /I libdof\include ^
            /I libdof\third-party\include ^
            libdof\build\Release\dof64.lib

      # --------------------------------------------------------------------
      # Collect artifacts
      # --------------------------------------------------------------------
      - name: Collect artifacts (Linux / macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/* dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Collect artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          cp ${{ matrix.wrapper_lib }} dist/
          cp ${{ matrix.dof_lib_glob }} dist/ 2>/dev/null || true
          cp libdof/third-party/runtime-libs/${{ matrix.platform }}/${{ matrix.arch }}/*.dll dist/ 2>/dev/null || true
          cp dof.py dist/
          cp example.py dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dof-python-${{ matrix.platform }}-${{ matrix.arch }}
          path: dist/

  # --------------------------------------------------------------------------
  # Release job
  # --------------------------------------------------------------------------
  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Zip bundles
        run: |
          cd artifacts
          for dir in */; do
            zip -r "../${dir%/}.zip" "$dir"
          done

      - uses: softprops/action-gh-release@v2
        with:
          files: '*.zip'
          generate_release_notes: true
